<html>
	<head>
		<title>City Weather</title>
		<link href='http://fonts.googleapis.com/css?family=Josefin+Sans' rel='stylesheet' type='text/css'>
		<script type="text/javascript" src="p5.js"></script>
        <script type="text/javascript" src="p5.dom.js"></script>
        <script type="text/javascript" src="Rain.js"></script>
        <script type="text/javascript" src="RainSystem.js"></script>
        <script type="text/javascript" src="Cloud.js"></script>
        <script type="text/javascript" src="CloudSystem.js"></script>
        <script type="text/javascript" src="Character.js"></script>
        <script type="text/javascript" src="CharacterSystem.js"></script>
        <script type="text/javascript" src="WindObject.js"></script>
        <script type="text/javascript" src="WindObjectSystem.js"></script>
        <!--<script type="text/javascript"
     	src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCN8G9vRi_BU6mvQpJM0Xvj6Itx2ntj8vQ?libraries=weather&sensor=FALSE"></script>-->
      <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?libraries=weather&sensor=FALSE"></script>
		<style type="text/css">
		body {		
			margin-top: 0px;
			padding: 0px;
			background: #F0F0F0;
			color: #FFF;
			font-family: 'Josefin Sans', sans-serif;
			font-weight: 700;
		    font-size: 40px;
		    line-height: 100%;
		    letter-spacing: -50%;
		    position: relative;
		    text-transform: uppercase;
		    /*z-index: -2;*/
		}
		.test {
			margin-bottom: 5px;
		    line-height: 100%;
		    font-weight: 700;
		    font-size: 40px;
		    /*z-index: 0;*/
		}
		input {
			margin-top: 10px;
			margin-bottom: 20px;
			color: #f0f0f0;
			text-transform: uppercase;
			border: 0px;
			width: 480px;
		    font-weight: 1;
		    font-size: 30px;
		}
		input:focus {
	    	outline: 0;
		}
		#htmlCanvas {
			margin: 20px;
		}
		#p5Canvas {
            margin-top: -20px;
            margin-left: -10px;
            position: absolute;
            top : 0px;
            left : 0px;
            z-index: -1;
        }
        #map_canvas {
        	margin = 0px;
        	padding = 0px;
        	/*opacity = 0.8;*/
        	z-index: 0;
        }
		</style>

		<!-- Load up the AJAX External JavaScript file -->
		<script type="text/javascript" src="p5.js">
		</script>

		<!-- Local Javascript Functions and so on -->
		<script type="text/javascript">
			// prompt("Type your city");
			// var city = prompt("Type your city", "New york");
			var city = "New york";
			var dirCloud;

			// var colors = ['#ff0000', '#00ff00', '#0000ff', '#ffffff'];
			var colors = ['#333333', '#333333', '#333333', '#333333'];

					
			// A function to call our AJAX PHP script
			function call_ajax()
			{
				//loadStrings('ajax_example.txt?' + Math.random()*100,ajax_return);
				loadJSON("http://api.openweathermap.org/data/2.5/weather?q=" + city + "&APPID=0962e0baaabfc5b30c3a529407d0d945&units=imperial", ajax_return);
			}

			function call_ajax_2()
			{
				//loadStrings('ajax_example.txt?' + Math.random()*100,ajax_return);
				loadJSON("http://api.openweathermap.org/data/2.5/weather?q=" + document.getElementById('thecity').value + "&APPID=0962e0baaabfc5b30c3a529407d0d945&units=imperial", ajax_return);
				// console.log("calling it");
			}



			// A function that gets called when ajax returns
			function ajax_return(result)
			{
				// console.log(result);

				var random_color = colors[Math.floor(Math.random() * colors.length)];
				document.body.style.color = random_color;
				document.getElementById("thecity").style.backgroundColor = random_color;

				document.getElementById("messages1").innerHTML = "Your City : " + result.name;				
				document.getElementById("messages2").innerHTML = result.weather[0].description;
				document.getElementById("messages4").innerHTML = "Cloud : " + result.clouds.all + "%";
				//for clouds factor (p5sketch)
				mCloudsAmountFactor = parseInt(result.clouds.all, 10);

				document.getElementById("messages5").innerHTML = "Wind Speed : " + result.wind.speed + " m/s";
				//for wind speed factor(p5sketch)
				mWindsSpeedFactor = parseFloat(result.wind.speed);
				// console.log(mWindsSpeedFactor);

				var F = parseInt(result.main.temp);
				var C = parseInt((F - 32) * 5/9);
				document.getElementById("messages6").innerHTML = "Temperature : " + F + " F, " + C + " C";
				//for character trigger (p5sketch)
				mCharacterFactor = C;

				document.getElementById("messages7").innerHTML = "Humidity : " + result.main.humidity + " %";
				//for amount of dust(windObject)
				mDustFactor = parseFloat(result.main.humidity);
				//for folded umbrella character
				if(!result.rain){
					if(mDustFactor > 49){
						mHumidFactor = true;
					} else {
						mHumidFactor = false;
					}
				} 

				//get latlon and move to it
				lat = result.coord.lat;
				lon = result.coord.lon;
				moveToCity();

				dirCloud = parseInt(result.clouds.all, 10);
				weatherId = parseInt(result.weather[0].id, 10);

				//if it rains, shows rain
				if (weatherId >= 200 && weatherId <= 531){
				    mRainsFactor = true;

				    //get precipitation
				    if(result.rain){
				    	// console.log('israinning');
				    	var precipitation = result.rain;
				    	console.log(precipitation);
					    // mRainsAmountFactor = precipitation;
					    mRainsAmountFactor = Math.random() * 100;
				    }
				} else {
					mRainsFactor = false;
				}

				for( var i = 0; i < result.length; i++ ){
					// console.log('working?');
					// console.log(result.weather[i]);
				}

				updateEvent();
			}

			function updateEvent() {
				//update p5 event 
				var numClouds = Math.ceil(mCloudsAmountFactor/2);
				mClouds.getEvent(numClouds, mWindsSpeedFactor);
				var mNumCharacters = mCharacterFactor;
				mCharacters.getEvent(mNumCharacters, mRainsFactor, mHumidFactor);
				var numDust = 100 - mDustFactor; 
				mWindObject.getEvent(numDust, mWindsSpeedFactor);
				mRains.getEvent(mRainsAmountFactor);
			}

			function setup_ajax(){
				document.getElementById('thecity').addEventListener('change',call_ajax_2);
			}

			//--------------------//
			//-------- map -------//
			//--------------------//
			var map;
			var lat;
			var lon;
			function initializeMap() {
				var styles = [{
	              featureType: "road",
	              elementType: "all",
	              stylers: [
	                { visibility: "off" }
	              ]
	            },{
	                elementType: "labels",
	                stylers: [
	                  { visibility: "off" },
	                  { color: "#333333" }
	                ]
	            },{
	                featureType: "water",
	                elementType: "geometry.fill",
	                stylers: [
	                  { visibility: "on" },
	                  { color: "#e0e0e0" }
	                ]
	              },{
	                "featureType": "landscape.natural.landcover",
	                "stylers": [
	                  { "visibility": "on" },
	                  { "color": "#333333" },
	                  { "weight": 10 }
	                ]
	              },{
	                featureType: "administrative",
	                stylers: [
	                  { visibility: "off" }
	                ]
	              },{
	                "featureType": "poi",
	                "stylers": [
	                  { "visibility": "off" }
	                ]
	              }
		        ];
		           
		        var styledMap = new google.maps.StyledMapType(styles, {name: "Styled Map"});
		                      
		        var mapOptions = {
		            center: new google.maps.LatLng(40.7141667, -74.0063889),
		            zoom: 5,
		            disableDefaultUI: true,
		            scrollwheel: true,
		            navigationControl: false,
		            mapTypeControl: false,
		            scaleControl: true,
		            draggable: true,
		            mapTypeControlOptions: {
		                mapTypeIds: [google.maps.MapTypeId.TERRAIN, 'map_style']
		            }
		        };
		        map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
		  
		        map.mapTypes.set('map_style', styledMap);
		        map.setMapTypeId('map_style');
		          
		        // var cloudLayer = new google.maps.weather.CloudLayer();
		        // cloudLayer.setMap(map);
		    }

		    function moveToCity(){
		    	map.panTo({lat: lat, lng: lon, noWrap: true});
		    	//add marker
		    	var marker = new google.maps.Marker({
				    position: {lat: lat, lng: lon},
				    // icon: {Symbol: {path: CIRCLE}},
				    map: map
				 });

			    marker.setMap(map);
		    }

			//---------------------//
			// ------ p5.js ------ //
			//---------------------//
			var mRains = new RainSystem();
			var mClouds = new CloudSystem();
			var mCharacters = new CharacterSystem();
			var mWindObject = new WindObjectSystem();

			var mCharacterFactor;
			var mCloudsAmountFactor;
			var mHumidFactor = false;
			var mDustFactor;
			var mRainsFactor = false;
			var mRainsAmountFactor = 0;
			var mWindsSpeedFactor;
			var bgImage;
			var bgForSunnyImage;
			// var mDarknessFactor;

			function setup(){
				var canvas = createCanvas(window.innerWidth, window.innerHeight);
				canvas.id("p5Canvas");

				mClouds.setup();
				mCharacters.setup();
				mWindObject.setup();

				bgImage = loadImage("bg.png");
				bgForSunnyImage = loadImage("bgForSunny.png");
			};

			function draw(){
				
				clear();
				// mDarknessFactor = (100 - mCloudsAmountFactor) * 2.55 + 100;
				// console.log(mDarknessFactor);
				// background(mDarknessFactor);

				//draw background
				if(mCloudsAmountFactor > 0){
					image(bgImage, 0, 0, window.innerWidth, 600);
				} else {
					image(bgForSunnyImage, 0, 0, window.innerWidth, window.innerHeight);
				}

				fill(255, Math.floor(Math.sin(millis() * 0.001) * 255), 0, 40);
				noStroke();
				var sunLoc01 = Math.floor(Math.sin(millis() * 0.001) * 10);
				var sunLoc02 = Math.floor(Math.cos(millis() * 0.001) * 10);
				//body
				ellipse(window.innerWidth * 0.8 + sunLoc01, window.innerHeight * 0.25, 300, 300);
				ellipse(window.innerWidth * 0.8 + sunLoc02, window.innerHeight * 0.25, 300, 300);
				ellipse(window.innerWidth * 0.8, window.innerHeight * 0.25 + sunLoc01, 300, 300);
				ellipse(window.innerWidth * 0.8, window.innerHeight * 0.25 + sunLoc02, 300, 300);
				//eye
				push();
				{
					translate(window.innerWidth * 0.8, window.innerHeight * 0.25);
					fill(30);
					ellipse(-100, 20, 30, 30);
					ellipse(70, 60, 30, 30);
				}
				pop();
				stroke();

				if(mRainsFactor){
					mRains.update();
					mRains.display();
				}
				
				mClouds.update();
				mClouds.display();

				mWindObject.update();
				mWindObject.display();

				mCharacters.update();
				mCharacters.display();
			};


			//--------------------------//
			// ------ rest input ------ //
			//--------------------------//
			function onFocus(){
                document.getElementById('thecity').value = ' ';
            }
            function onBlur(){
                document.getElementById('thecity').value = 'Type City Name Here..';
            }


            //--------------------------//
			// ------ initialize ------ //
			//--------------------------//
            // Register setup_ajax with the onload event of the window (when it is done loading)..	
			window.addEventListener('load', call_ajax);
			window.addEventListener('load', setup_ajax);
			window.addEventListener('load', initializeMap);

		</script>
	</head>
	<body>
		<div>
			<div id="htmlCanvas">
				<div id="messages1" class="test"></div>
				<div class="test">-</div>
				<div id="messages2" class="test"></div>
				<div id="messages3" class="test"></div>
				<div id="messages4" class="test"></div>
				<div id="messages5" class="test"></div>
				<div id="messages6" class="test"></div>
				<div id="messages7" class="test"></div>
				<input type="text" id="thecity" onfocus="onFocus()" onblur="onBlur()" value="Type City Name Here.." class="input">
				<div id="map_canvas" style="width:480px; height:200px"></div>
			</div>
		<div>
	</body>
</html>





